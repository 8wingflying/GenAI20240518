# -*- coding: utf-8 -*-
"""OpenAI_Programming_1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1X0t5Ak6JdUoim3Y1wqxIE2mmFkliKPod

## OpenAI Programming_1

### è³‡æ–™ä¾†æº  
- æœ€å¼· AI æŠ•è³‡åˆ†æï¼šæ‰“é€ è‡ªå·±çš„è‚¡å¸‚é¡§å•æ©Ÿå™¨äººï¼Œè‚¡ç¥¨è¶¨å‹¢åˆ†æÃ—å¹´å ±è§£è®€Ã—é¸è‚¡æ¨è–¦Ã—é¢¨éšªç®¡ç†
- æ–½å¨éŠ˜ç ”ç©¶å®¤
- CH-02 å¾é›¶é–‹å§‹çš„ OpenAI API
-

## 2-3 å»ºæ§‹è‡ªå·±çš„ AI æ©Ÿå™¨äºº

### 1ï¸âƒ£ ä½¿ç”¨ OpenAI API å®˜æ–¹å¥—ä»¶

OpenAI å®˜æ–¹æä¾›æœ‰ openai å¥—ä»¶, å¯ä»¥ç°¡åŒ–ä½¿ç”¨ä¸Šçš„è¤‡é›œåº¦ã€‚
"""

!pip install openai

"""### 2ï¸âƒ£ è¼¸å…¥ API KEY
getpass å¥—ä»¶å¯ä»¥éš±è—è¼¸å…¥å€¼
"""

from openai import OpenAI, OpenAIError # OpenAI å®˜æ–¹å¥—ä»¶
import getpass # ä¿å¯†è¼¸å…¥å¥—ä»¶
api_key = getpass.getpass("è«‹è¼¸å…¥é‡‘é‘°ï¼š")
client = OpenAI(api_key = api_key) # å»ºç«‹ OpenAI ç‰©ä»¶

"""### 3ï¸âƒ£ å»ºæ§‹æ¨¡å‹ä¸¦äº¤è«‡"""

reply = client.chat.completions.create(
    model = "gpt-3.5-turbo",
    # model = "gpt-4",
    messages = [
        {"role":"user", "content": "ä½ ä½çš„åœ°æ–¹å¾ˆäº®å—ï¼Ÿ"}
    ]
)

"""### 4ï¸âƒ£ æª¢è¦–å‚³å›ç‰©ä»¶"""

print(reply)

"""### 5ï¸âƒ£ æª¢è¦–è¨Šæ¯å…§å®¹"""

print(reply.choices[0].message.content)

"""### 6ï¸âƒ£ è¨­å®š AI è§’è‰²"""

reply = client.chat.completions.create(
    model = "gpt-3.5-turbo",
    messages = [
        {"role":"system", "content":"ä½ æ˜¯éš»ä½åœ¨å¤–å¤ªç©ºçš„çŒ´å­"},
        {"role":"user", "content": "ä½ ä½çš„åœ°æ–¹å¾ˆäº®å—ï¼Ÿ reply in ç¹é«”ä¸­æ–‡"}
    ]
)

print(reply.choices[0].message.content)

"""### 7ï¸âƒ£ å¯«æˆå‡½å¼"""

def get_reply(messages):
    try:
        response = client.chat.completions.create(
            model = "gpt-3.5-turbo",
            messages = messages
        )
        reply = response.choices[0].message.content
    except OpenAIError as err:
        reply = f"ç™¼ç”Ÿ {err.error.type} éŒ¯èª¤\n{err.error.message}"
    return reply

"""### 8ï¸âƒ£ ç°¡æ˜“çš„å°è«‡ç¨‹å¼"""

while True:
    msg = input("ä½ èªªï¼š")
    if not msg.strip(): break
    messages = [{"role":"user", "content":msg}]
    reply = get_reply(messages)
    print(f"ã„Ÿå”‰ï¼š{reply}\n")

"""### 9ï¸âƒ£ è¨˜æ†¶å°è©±ç´€éŒ„çš„å‡½å¼"""

hist = []       # æ­·å²å°è©±ç´€éŒ„
backtrace = 2   # è¨˜éŒ„å¹¾çµ„å°è©±

def chat(sys_msg, user_msg):
    hist.append({"role":"user", "content":user_msg})
    reply = get_reply(hist
                      + [{"role":"system", "content":sys_msg}])
    while len(hist) >= 2 * backtrace: # è¶…éè¨˜éŒ„é™åˆ¶
        hist.pop(0)                   # ç§»é™¤æœ€èˆŠç´€éŒ„
    hist.append({"role":"assistant", "content":reply})
    return reply

"""### ğŸ”Ÿ èƒ½æ¥çºŒå°è©±çš„ AI ç¨‹å¼"""

sys_msg = input("ä½ å¸Œæœ›ã„Ÿå”‰æ‰®æ¼”ï¼š")
if not sys_msg.strip(): sys_msg = 'å°åŠ©ç†'
print()
while True:
    msg = input("ä½ èªªï¼š")
    if not msg.strip(): break
    reply = chat(sys_msg, msg)
    print(f"{sys_msg}:{reply}\n")
hist = []

"""### 1ï¸âƒ£1ï¸âƒ£ å®‰è£èˆ‡åŒ¯å…¥ google æœå°‹å¥—ä»¶

"""

!pip install googlesearch-python
from googlesearch import search

"""### 1ï¸âƒ£2ï¸âƒ£ ä½¿ç”¨ google æœå°‹å¥—ä»¶"""

for item in search(
    "NBA 2023 å† è»éšŠ", advanced=True, num_results=3):
    print(item.title)
    print(item.description)
    print(item.url)
    print()

"""### 1ï¸âƒ£3ï¸âƒ£ å°‡æœå°‹çµæœåŠ å…¥åˆ° content ä¸­"""

hist = []       # æ­·å²å°è©±ç´€éŒ„
backtrace = 2   # è¨˜éŒ„å¹¾çµ„å°è©±

def chat_w(sys_msg, user_msg, search_g = True):
    web_res = []
    if search_g == True: # ä»£è¡¨è¦æœå°‹ç¶²è·¯
        content = "ä»¥ä¸‹ç‚ºå·²ç™¼ç”Ÿçš„äº‹å¯¦ï¼š\n"
        for res in search(user_msg, advanced=True,
                          num_results=3, lang='zh-TW'):
            content += f"æ¨™é¡Œï¼š{res.title}\n" \
                       f"æ‘˜è¦ï¼š{res.description}\n\n"
        content += "è«‹ä¾ç…§ä¸Šè¿°äº‹å¯¦å›ç­”å•é¡Œ \n"
        web_res = [{"role": "user", "content": content}]
    web_res.append({"role": "user", "content": user_msg})
    while len(hist) >= 2 * backtrace: # è¶…éè¨˜éŒ„é™åˆ¶
        hist.pop(0)  # ç§»é™¤æœ€èˆŠçš„ç´€éŒ„
    reply_full = ""
    for reply in get_reply(
        hist                          # å…ˆæä¾›æ­·å²ç´€éŒ„
        + web_res                     # å†æä¾›æœå°‹çµæœåŠç›®å‰è¨Šæ¯
        + [{"role": "system", "content": sys_msg}]):
        reply_full += reply           # è¨˜éŒ„åˆ°ç›®å‰ç‚ºæ­¢æ”¶åˆ°çš„è¨Šæ¯
        yield reply                   # å‚³å›æœ¬æ¬¡æ”¶åˆ°çš„ç‰‡æ®µè¨Šæ¯
    hist.append({"role": "user", "content": user_msg})
    while len(hist) >= 2 * backtrace: # è¶…éè¨˜éŒ„é™åˆ¶
        hist.pop(0)                   # ç§»é™¤æœ€èˆŠç´€éŒ„
    hist.append({"role":"assistant", "content":reply_full})

"""### 1ï¸âƒ£4ï¸âƒ£ çªç ´æœå°‹é™åˆ¶çš„èŠå¤©æ©Ÿå™¨äºº"""

sys_msg = 'å°åŠ©ç†'

while True:
    msg = input("ä½ èªªï¼š")
    if not msg.strip(): break
    print(f"{sys_msg}ï¼š", end = "")
    for reply in chat_w(sys_msg, msg, search_g = True):
        print(reply, end = "")
    print('\n')
hist = []